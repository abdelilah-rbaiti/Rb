@Library('jenkins_shared_library@main') _
pipeline {
      environment {
        DOCKER_IMAGE_NAME = ''
    agent any
    stages {
        stage('Git Checkout') {
                steps {
                    script {
                        gitCheckout(
                            branch: 'main',
                            url: 'https://github.com/abdelilah-rbaiti/Rb.git'
                        )
                    }
                }
            } 
                 stage('Unit Tests') {
                    steps {
                        script {
                            myUnitTests.runUnitTests()
                }
            }
        }
                stage('Integration Tests') {
                    steps {
                        script {                    
                            myIntegrationTests.runIntegrationTests()
                }
            }
        }
                stage('Static code analysis: Sonarqube'){
                    steps{
                       script{
                            def SonarQubecredentialsId = 'SONAR'
                           SonarqubeAnalyses(SonarQubecredentialsId)
               }
            }
        }
                 stage('Maven Build : maven'){
                    steps{
                       script{
                              mvnBuild.mvnBuild()
               }
            }
        }
                stage('Build Docker Image') {
                    steps {
                       script {
                            DOCKER_IMAGE_NAME = buildDockerImage('java-app')
                            echo "Built Docker image: ${DOCKER_IMAGE_NAME}"
                }
            }
        }
               stage('Docker Image Scan: trivy') {
            steps {
                script {
                    // Scan Docker image using Trivy
                    scanDockerImage(DOCKER_IMAGE_NAME)
                    // Display scan results
                    sh "cat scan.txt"
                }
            }
        }
    }
}

